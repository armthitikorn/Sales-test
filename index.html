<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>AI Telesales Simulator v4.3 (Fast Male Voice)</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --bg: #f0f2f5; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 700px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
        header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .api-panel { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: grid; gap: 10px; }
        input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        #chat-window { height: 400px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 15px; font-size: 15px; line-height: 1.5; }
        .customer { align-self: flex-start; background: #f1f5f9; color: #1e293b; border-bottom-left-radius: 2px; }
        .agent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .controls { padding: 20px; border-top: 1px solid #f1f5f9; text-align: center; }
        #status { margin-bottom: 10px; font-size: 14px; color: #64748b; font-weight: bold; }
        button { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; background: #10b981; color: white; transition: 0.3s; }
        button:disabled { background: #cbd5e1; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>üéß AI Telesales Simulator</h2>
        <p style="margin:5px 0 0 0; font-size: 0.8em; opacity: 0.9;">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (‡πÇ‡∏´‡∏°‡∏î: ‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏µ‡∏£‡∏∞ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏≤‡∏¢/‡∏ï‡∏≠‡∏ö‡πÑ‡∏ß)</p>
    </header>

    <div class="api-panel">
        <input type="password" id="gemini-key" placeholder="‡∏ß‡∏≤‡∏á Gemini API Key">
        <input type="password" id="gcp-key" placeholder="‡∏ß‡∏≤‡∏á Google Cloud API Key">
    </div>

    <div id="chat-window">
        <div class="msg customer">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: (‡∏£‡∏≠‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤...)</div>
    </div>

    <div class="controls">
        <div id="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
        <button id="talk-btn">üéôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î (Push to Talk)</button>
    </div>
</div>

<script>
    const talkBtn = document.getElementById('talk-btn');
    const statusBox = document.getElementById('status');
    const chatWindow = document.getElementById('chat-window');

    let isProcessing = false;

    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new Recognition();
    recognition.lang = 'th-TH';

    talkBtn.addEventListener('click', () => {
        if (isProcessing) return;
        recognition.start();
        statusBox.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Ñ‡∏∏‡∏ì...";
        talkBtn.disabled = true;
    });

    recognition.onresult = (event) => {
        const text = event.results[0][0].transcript;
        appendMessage('agent', text);
        askGemini(text);
    };

    recognition.onend = () => { if (!isProcessing) talkBtn.disabled = false; };

    // --- 1. ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Gemini 2.5 Flash ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß ---
    async function askGemini(userInput) {
        isProcessing = true;
        statusBox.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏µ‡∏£‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...";
        const apiKey = document.getElementById('gemini-key').value.trim();
        
        // ‡πÉ‡∏ä‡πâ‡∏£‡∏∏‡πà‡∏ô 2.5 Flash ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÑ‡∏ß‡πâ‡∏Ñ‡∏£‡∏±‡∏ö
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
        
        const prompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ '‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏µ‡∏£‡∏∞' ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∏‡πà‡∏á‡∏°‡∏≤‡∏Å 
                       ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó: ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏†‡∏≤‡∏û‡πÅ‡∏ï‡πà‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ô‡πà‡∏ô
                       ‡∏Å‡∏é‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
                       ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏û‡∏π‡∏î‡∏ß‡πà‡∏≤: "${userInput}"`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { maxOutputTokens: 50, temperature: 0.7 }
                })
            });
            const data = await response.json();
            const aiResponse = data.candidates[0].content.parts[0].text;
            
            appendMessage('customer', aiResponse);
            await speakPremium(aiResponse); 
        } catch (e) {
            statusBox.innerText = "Error: " + e.message;
        } finally {
            isProcessing = false;
            statusBox.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢";
            talkBtn.disabled = false;
        }
    }

    // --- 2. ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏õ‡∏µ‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î ---
// --- 2. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (Gemini 2.5 Flash) ---
    async function askGemini(userInput) {
        isProcessing = true;
        statusBox.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏µ‡∏£‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á...";
        const apiKey = document.getElementById('gemini-key').value.trim();
        
        // ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÉ‡∏ä‡πâ Gemini 2.5 Flash ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏±‡πà‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏™‡∏°‡∏≠
        const modelId = "gemini-2.5-flash"; 
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${apiKey}`;
        
        const prompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ '‡∏Ñ‡∏∏‡∏ì‡∏ß‡∏µ‡∏£‡∏∞' ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∏‡πà‡∏á 
                       ‡∏Å‡∏é: ‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10 ‡∏Ñ‡∏≥) 
                       ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå: ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ
                       ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏û‡∏π‡∏î: "${userInput}"`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { maxOutputTokens: 50, temperature: 0.7 }
                })
            });
            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);

            const aiResponse = data.candidates[0].content.parts[0].text;
            appendMessage('customer', aiResponse);
            
            // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
            await speakPremium(aiResponse); 
            
        } catch (e) {
            statusBox.innerText = "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô: " + e.message;
        } finally {
            isProcessing = false;
            if (!statusBox.innerText.includes("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô")) statusBox.innerText = "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏¢";
            talkBtn.disabled = false;
        }
    }

    // --- 3. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ó‡∏û (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î Error 400) ---
    async function speakPremium(text) {
        const apiKey = document.getElementById('gcp-key').value.trim();
        if (!apiKey || !text) return;

        const url = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${apiKey}`;
        
        // ‚úÖ ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏û‡∏¥‡πà‡∏° Headers ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ Error 400
        const requestOptions = {
            method: "POST",
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({
                input: { text: text },
                voice: { 
                    languageCode: "th-TH", 
                    name: "th-TH-Standard-B" // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢
                },
                audioConfig: { 
                    audioEncoding: "MP3", 
                    speakingRate: 1.2 // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏±‡∏ö
                }
            })
        };

        try {
            const response = await fetch(url, requestOptions);
            const data = await response.json();
            
            if (!response.ok) throw new Error(data.error?.message || "GCP API Error");

            if (data.audioContent) {
                const audio = new Audio("data:audio/mp3;base64," + data.audioContent);
                await audio.play();
            }
        } catch (e) {
            console.error("TTS Error:", e);
            statusBox.innerText = "‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á: " + e.message;
        }
    }
    function appendMessage(role, text) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = (role === 'agent' ? 'üôã‚Äç‚ôÇÔ∏è ‡∏Ñ‡∏∏‡∏ì: ' : 'üë§ ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ') + text;
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
</script>

</body>
</html>
